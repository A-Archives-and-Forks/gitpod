# Overview
ws-deployment is a cli used to deploy gitpod workspace to a new cluster. It uses a combination of existing tools, scripts and methodologies to achieve this.

Please refer to [this design doc](https://www.notion.so/gitpod/Deployment-Process-Workspace-5f082cc8387447f5940ffb8389bb4fc7) where we had first set of proposals and discussions. For the first iteration we decided to do things with the following in mind:
`Create immutable workspace clusters and avoid as much manual intervention as possible.`

# What
Broadly these are the steps/things that it does in the given order:

1. Use [ops repository](https://github.com/gitpod-io/ops) to create Terraform Modules based on the given config
1. Use terraform to apply these terraform module. This creates workspace cluster/(s) and associated infrastructure
1. Installs gitpod on the cluster/(s) created in previous step using helm
1. Run a Dead or Alive check on these clusters
1. Register the clusters with right cordoned and govern flag to appropriate meta clusters as defined in the config
1. Shift Traffic to the new clusters


# How
This is the flow that we are building to achive automated gitpod deployment:

1. A config (default `$HOME/ws-deployment.yaml`) is read by the cli `ws-deployment` and validated based on the version. Currently the config looks similar to below but is constantly being updated as we make progress.
    ```yaml
    version: v1
    environment: production
    project: gitpod-staging # the id of the gcp project
    #TODO(prs): gcpSecretPath: /var/gcp/gitpod-sa.json

    metaClusters:
    - name: prod-meta-eu00
      region: europe-west1
    - name: prod-meta-us01
      region: us-west-1
    workspaceClusters:
    - region: europe-west1
        prefix: eu
        governedBy: prod-meta-eu01
        create: true
        type: gke
    - region: us-east1
        prefix: us
        governedBy: prod-meta-us01
        create: true
        type: gke
    ```
    TODO(prs) Explanation of each field
1. A random cluster id is generated which is used to generate cluster names. e.g. a cluster id 17 in region `europe-west1` in `production` with prefix value in above config set to `eu` will result in a cluster being created with name `gp-prod-ws-eu17-eu-west1`. This is generated by terraform scripts in the [ops repository](https://github.com/gitpod-io/ops)
1. We follow a set of steps as mentioned below. Each step may or may not have a pre run check. For example creating a workspace cluster will likely have a check to see if a cluster with the generated name already exists
    1. **CreateClusterStep** - Use [build-cluster.sh](https://github.com/gitpod-io/ops/blob/main/dev/build-ws-cluster/build-ws-cluster.sh) script to generate terraform modules.
    1. **InstallGitpodStep** - Use `helm install` to install gitpod
    1. **InstallJaegerStep** - Use `helm install` to install jaeger
    1. **InstallMonitoringStep** - Use `helm install` to install monitoring-satellite
    1. **AliveTestStep** - Use `go test` to test if gitpod installation on the cluster/(s) is alive
    1. **RegisterClusterStep** - Use `gpctl` to register the cluster/(s)
    1. **TrafficShiftStep** - Use `werft shift-traffic` job to trigger a traffic shift to new cluster/(s)


    I have suggested to use a particular approach in each step based on discussion with Chris that we want to strive for complete automation without introducing manual intervention. Therefore, I have added recommendations like using helm instead of argo cd as the latter would require us to commit values files to the ops repo.



# Where does this Run
I propose we use a werft job (e.g. [branch](https://github.com/gitpod-io/ops/tree/prs/wspace-cluster-auto) where I am trying to do this. This is outdated though) inside the [ops repository](https://github.com/gitpod-io/ops) and then build this cli in the submodule `gitpod-core`.

I propose we give the ops repository's commit as an input to this werft job (just like how we do it now). The version of gitpod in the values version yaml file will be used to deploy gitpod.

Alternatively, once we have installer production ready, we can use gitpod commit ids to deploy a specific version of gitpod.

# Current Status
We are far away from having anything executable. I have been only able to create the framework for writing prerun checks and steps. We need to do these (in parallel):

* Fill in the method `initializeWorkspaceClusterNames` to generate cluster names
* Use/create random id generator
* Code for cli using cobra cli
* Orchestrator module inside the `cmd` to initialize and call appropriate `ISteps`
* Fill in all the implementation of `IStep` and `IPreRun` interfaces


* Basic tests can be added with above tasks but not mandatory

# Next Phase
In the next phase we would want to achive the following:
1. Metrics based traffic shift
1. Rollback on failure metrics
1. Cluster destruction post complete traffic migration